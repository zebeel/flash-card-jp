<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>æ—¥æœ¬èªãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --ink: #1a1a1a;
    --paper: #f5f0e8;
    --washi: #ede8dd;
    --vermillion: #c0392b;
    --gold: #c9a84c;
    --sky: #5b8fb9;
    --sage: #6b8f71;
    --shadow: rgba(0,0,0,0.12);
    --radius: 20px;
    --trans: cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  html, body {
    height: 100%;
    overflow: hidden;
    background: var(--paper);
    color: var(--ink);
    font-family: 'Noto Sans JP', sans-serif;
    -webkit-font-smoothing: antialiased;
  }

  /* â”€â”€â”€ APP SHELL â”€â”€â”€ */
  #app {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
  }

  /* â”€â”€â”€ PAGE TRANSITIONS â”€â”€â”€ */
  .page {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    transition: transform 0.5s cubic-bezier(0.77,0,0.175,1), opacity 0.5s ease;
  }
  .page.hidden {
    transform: translateX(100%);
    opacity: 0;
    pointer-events: none;
  }
  .page.slide-out {
    transform: translateX(-100%);
    opacity: 0;
  }

  /* â”€â”€â”€ BACKGROUND TEXTURE â”€â”€â”€ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Ccircle cx='30' cy='30' r='0.8' fill='%23c9a84c' opacity='0.15'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOMEPAGE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #home-page {
    padding: 0;
    background: var(--paper);
  }

  .home-header {
    padding: 56px 32px 24px;
    position: relative;
    z-index: 1;
  }

  .home-header .jp-title {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 0.3em;
    color: var(--gold);
    text-transform: uppercase;
    margin-bottom: 8px;
  }

  .home-header h1 {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 38px;
    font-weight: 900;
    line-height: 1.1;
    color: var(--ink);
    letter-spacing: -0.02em;
  }

  .home-header h1 span {
    display: block;
    color: var(--vermillion);
  }

  /* Red stripe decoration */
  .stripe-decor {
    width: 48px;
    height: 4px;
    background: var(--vermillion);
    border-radius: 2px;
    margin: 16px 0 8px 32px;
  }

  /* Scrollable settings area */
  .home-body {
    flex: 1;
    overflow-y: auto;
    padding: 8px 24px 32px;
    position: relative;
    z-index: 1;
    -webkit-overflow-scrolling: touch;
  }

  /* â”€â”€â”€ SETTING CARDS â”€â”€â”€ */
  .setting-card {
    background: #fff;
    border-radius: var(--radius);
    padding: 20px 22px;
    margin-bottom: 14px;
    box-shadow: 0 2px 12px var(--shadow);
    border: 1px solid rgba(201,168,76,0.15);
  }

  .setting-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .setting-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(201,168,76,0.25);
  }

  /* Script toggle */
  .script-toggle {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .script-btn {
    padding: 14px 8px;
    border: 2px solid transparent;
    border-radius: 12px;
    background: var(--washi);
    cursor: pointer;
    text-align: center;
    transition: all 0.25s var(--trans);
    position: relative;
    overflow: hidden;
  }

  .script-btn .jp {
    display: block;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 26px;
    font-weight: 900;
    color: var(--ink);
    line-height: 1.2;
    transition: color 0.2s;
  }

  .script-btn .en {
    display: block;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #999;
    margin-top: 2px;
    transition: color 0.2s;
  }

  .script-btn.active {
    border-color: var(--vermillion);
    background: #fff5f4;
  }

  .script-btn.active .jp { color: var(--vermillion); }
  .script-btn.active .en { color: var(--vermillion); }

  .script-btn:hover:not(.active) {
    border-color: rgba(201,168,76,0.4);
    transform: translateY(-1px);
  }

  /* Topic cards */
  .topic-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }

  .topic-btn {
    padding: 16px 10px;
    border: 2px solid transparent;
    border-radius: 14px;
    background: var(--washi);
    cursor: pointer;
    text-align: center;
    transition: all 0.25s var(--trans);
  }

  .topic-btn .icon {
    font-size: 32px;
    line-height: 1;
    margin-bottom: 6px;
    display: block;
  }

  .topic-btn .jp-name {
    display: block;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
  }

  .topic-btn .count {
    display: block;
    font-size: 10px;
    letter-spacing: 0.1em;
    color: #aaa;
    margin-top: 2px;
    font-family: 'Space Mono', monospace;
  }

  .topic-btn.active {
    border-color: var(--sky);
    background: #f0f6fc;
  }

  .topic-btn.active .jp-name { color: var(--sky); }
  .topic-btn:hover:not(.active) {
    border-color: rgba(91,143,185,0.3);
    transform: translateY(-1px);
  }

  /* Auto-speak toggle */
  .auto-speak-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .auto-speak-info .title {
    font-size: 16px;
    font-weight: 700;
    color: var(--ink);
  }

  .auto-speak-info .desc {
    font-size: 12px;
    color: #999;
    margin-top: 2px;
    line-height: 1.4;
  }

  /* iOS-style toggle */
  .toggle {
    width: 52px;
    height: 30px;
    position: relative;
    cursor: pointer;
    flex-shrink: 0;
  }

  .toggle input { display: none; }

  .toggle-track {
    width: 100%;
    height: 100%;
    background: #ddd;
    border-radius: 15px;
    transition: background 0.25s ease;
    position: relative;
  }

  .toggle-thumb {
    position: absolute;
    top: 3px;
    left: 3px;
    width: 24px;
    height: 24px;
    background: white;
    border-radius: 50%;
    transition: transform 0.25s var(--trans);
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }

  .toggle input:checked ~ .toggle-track {
    background: var(--sage);
  }

  .toggle input:checked ~ .toggle-track .toggle-thumb {
    transform: translateX(22px);
  }

  /* Start button */
  .start-btn {
    width: 100%;
    padding: 18px;
    border: none;
    border-radius: var(--radius);
    background: var(--vermillion);
    color: white;
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 17px;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    margin-top: 6px;
    box-shadow: 0 6px 20px rgba(192,57,43,0.4);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }

  .start-btn:hover {
    background: #a93226;
    transform: translateY(-2px);
    box-shadow: 0 10px 28px rgba(192,57,43,0.45);
  }

  .start-btn:active {
    transform: translateY(0);
    box-shadow: 0 4px 12px rgba(192,57,43,0.35);
  }

  .start-btn .arrow {
    font-size: 20px;
    transition: transform 0.2s ease;
  }

  .start-btn:hover .arrow {
    transform: translateX(4px);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FLASHCARD PAGE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #flash-page {
    background: var(--paper);
  }

  /* Top bar */
  .flash-topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 52px 20px 12px;
    position: relative;
    z-index: 10;
  }

  .back-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    box-shadow: 0 2px 10px var(--shadow);
    transition: all 0.2s ease;
  }

  .back-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 16px var(--shadow);
  }

  .progress-info {
    text-align: center;
  }

  .progress-text {
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    color: var(--ink);
    font-weight: 700;
  }

  .progress-sub {
    font-size: 10px;
    color: #bbb;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-top: 1px;
  }

  .shuffle-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: white;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    box-shadow: 0 2px 10px var(--shadow);
    transition: all 0.3s ease;
  }

  .shuffle-btn:hover {
    transform: rotate(180deg);
    box-shadow: 0 4px 16px var(--shadow);
  }

  /* Progress bar */
  .progress-bar-wrap {
    height: 3px;
    background: rgba(0,0,0,0.08);
    margin: 0 24px;
    border-radius: 2px;
    overflow: hidden;
  }

  .progress-bar-fill {
    height: 100%;
    background: var(--vermillion);
    border-radius: 2px;
    transition: width 0.4s ease;
  }

  /* Card area */
  .card-area {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    position: relative;
    overflow: hidden;
  }

  /* Swipe hint */
  .swipe-hint {
    position: absolute;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    opacity: 0.4;
    font-size: 11px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    white-space: nowrap;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }

  .swipe-hint.faded { opacity: 0; }

  .swipe-hint .dot {
    width: 4px;
    height: 4px;
    border-radius: 50%;
    background: var(--ink);
  }

  /* â”€â”€â”€ FLASHCARD â”€â”€â”€ */
  .card-scene {
    width: 100%;
    max-width: 340px;
    aspect-ratio: 3/4;
    perspective: 1200px;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
  }

  .card-inner {
    width: 100%;
    height: 100%;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.55s cubic-bezier(0.4,0,0.2,1);
  }

  .card-inner.flipped {
    transform: rotateY(180deg);
  }

  .card-face {
    position: absolute;
    inset: 0;
    border-radius: 24px;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    overflow: hidden;
    box-shadow: 
      0 4px 20px rgba(0,0,0,0.1),
      0 12px 40px rgba(0,0,0,0.08);
  }

  /* Front face â€” image */
  .card-front {
    background: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0;
  }

  .card-image-wrap {
    flex: 1;
    width: 100%;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  .card-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    transition: opacity 0.3s ease;
  }

  .card-img-fallback {
    position: absolute;
    inset: 0 10%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: clamp(120px, 32vw, 220px);
    line-height: 1;
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .card-img.loading {
    opacity: 0;
  }

  .card-img.error {
    opacity: 0;
  }

  .card-img.error ~ .card-img-fallback {
    opacity: 1;
  }

  .card-front-label {
    width: 100%;
    flex-shrink: 0;
    padding: 16px 20px 20px;
    text-align: center;
    border-top: 1px solid rgba(0,0,0,0.06);
    background: white;
  }

  .card-front-label .romaji {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: var(--ink);
    letter-spacing: 0.08em;
    white-space: nowrap;
    overflow: visible;
  }

  .tap-hint {
    position: absolute;
    top: 16px;
    right: 16px;
    background: rgba(0,0,0,0.06);
    border-radius: 20px;
    padding: 4px 10px;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #aaa;
  }

  /* Back face â€” kana */
  .card-back {
    background: var(--ink);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transform: rotateY(180deg);
    position: relative;
  }

  /* Back decorative pattern */
  .card-back::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30'%3E%3Ccircle cx='15' cy='15' r='1' fill='%23ffffff' opacity='0.04'/%3E%3C/svg%3E");
  }

  .card-back-content {
    flex: 1;
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
  }

  .kana-display {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 88px;
    font-weight: 900;
    color: white;
    line-height: 1;
    letter-spacing: 0.05em;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    white-space: nowrap;
    width: 100%;
    text-align: center;
    padding: 0 16px;
  }

  @keyframes kanaReveal {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .card-back-footer {
    width: 100%;
    flex-shrink: 0;
    padding: 16px 20px 20px;
    text-align: center;
    border-top: 1px solid rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    z-index: 1;
  }

  .kana-romaji {
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.2em;
    text-transform: lowercase;
  }

  /* Sound button on back */
  .sound-btn {
    position: absolute;
    right: 20px;
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 50%;
    background: rgba(255,255,255,0.12);
    color: white;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(8px);
  }

  .sound-btn:hover {
    background: rgba(255,255,255,0.22);
    transform: scale(1.1);
  }

  .sound-btn.playing {
    background: var(--gold);
    animation: pulse 0.6s ease;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.15); }
  }

  /* Script badge on back */
  .script-badge {
    position: absolute;
    top: 20px;
    left: 20px;
    background: rgba(255,255,255,0.1);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 8px;
    padding: 4px 10px;
    font-size: 10px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.5);
    z-index: 1;
  }

  /* Card transition animation */
  @keyframes cardSlideIn {
    from { opacity: 0; transform: translateX(60px) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
  }

  @keyframes cardSlideInLeft {
    from { opacity: 0; transform: translateX(-60px) scale(0.95); }
    to { opacity: 1; transform: translateX(0) scale(1); }
  }

  @keyframes floatIn {
    from { opacity: 0; transform: scale(0.85) translateY(10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }

  .card-scene.anim-right .card-inner {
    animation: cardSlideIn 0.4s var(--trans) both;
  }

  .card-scene.anim-left .card-inner {
    animation: cardSlideInLeft 0.4s var(--trans) both;
  }

  /* Swipe gesture trail */
  .card-scene.dragging .card-inner {
    transition: none;
  }

  /* â”€â”€â”€ Completed screen â”€â”€â”€ */
  .complete-screen {
    position: absolute;
    inset: 0;
    background: var(--paper);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 40px;
    text-align: center;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
    z-index: 20;
  }

  .complete-screen.visible {
    opacity: 1;
    pointer-events: all;
  }

  .complete-kanji {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 72px;
    font-weight: 900;
    color: var(--vermillion);
    line-height: 1;
    margin-bottom: 16px;
  }

  .complete-title {
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 26px;
    font-weight: 700;
    color: var(--ink);
    margin-bottom: 8px;
  }

  .complete-sub {
    font-size: 14px;
    color: #aaa;
    letter-spacing: 0.08em;
    margin-bottom: 40px;
  }

  .complete-btn {
    padding: 16px 40px;
    border: none;
    border-radius: var(--radius);
    font-family: 'Noto Sans JP', sans-serif;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s ease;
    margin: 6px;
  }

  .complete-btn-primary {
    background: var(--vermillion);
    color: white;
    box-shadow: 0 4px 16px rgba(192,57,43,0.4);
  }

  .complete-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(192,57,43,0.45);
  }

  .complete-btn-secondary {
    background: white;
    color: var(--ink);
    box-shadow: 0 2px 10px var(--shadow);
  }

  /* â”€â”€â”€ Auto-speak indicator â”€â”€â”€ */
  .autospeak-indicator {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--sage);
    color: white;
    padding: 6px 16px;
    border-radius: 20px;
    font-size: 12px;
    letter-spacing: 0.1em;
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
    z-index: 100;
    white-space: nowrap;
  }

  .autospeak-indicator.show {
    opacity: 1;
  }

  /* â”€â”€â”€ Responsive â”€â”€â”€ */
  @media (max-width: 360px) {
    .kana-display { font-size: 72px; }
    .card-emoji { font-size: 88px; }
  }

  @media (min-height: 800px) {
    .card-scene {
      max-width: 380px;
    }
  }
</style>
</head>
<body>
<div id="app">

  <!-- â•â•â•â•â•â• HOME PAGE â•â•â•â•â•â• -->
  <div id="home-page" class="page">
    <div class="home-header">
      <div class="jp-title">æ—¥æœ¬èª Â· Japanese</div>
      <h1>ãƒ•ãƒ©ãƒƒã‚·ãƒ¥<span>ã‚«ãƒ¼ãƒ‰</span></h1>
    </div>
    <div class="stripe-decor"></div>

    <div class="home-body">
      <!-- Script selection -->
      <div class="setting-card">
        <div class="setting-label">æ–‡å­— Â· Script</div>
        <div class="script-toggle">
          <button class="script-btn active" data-script="hiragana">
            <span class="jp">ã‚</span>
            <span class="en">Hiragana</span>
          </button>
          <button class="script-btn" data-script="katakana">
            <span class="jp">ã‚¢</span>
            <span class="en">Katakana</span>
          </button>
        </div>
      </div>

      <!-- Topic selection -->
      <div class="setting-card">
        <div class="setting-label">ãƒ†ãƒ¼ãƒ Â· Topic</div>
        <div class="topic-grid">
          <button class="topic-btn active" data-topic="shinkansen">
            <span class="icon">ğŸš„</span>
            <span class="jp-name">æ–°å¹¹ç·š</span>
            <span class="count">7 cards</span>
          </button>
          <button class="topic-btn" data-topic="animals">
            <span class="icon">ğŸ¾</span>
            <span class="jp-name">å‹•ç‰©</span>
            <span class="count">8 cards</span>
          </button>
        </div>
      </div>

      <!-- Auto speak -->
      <div class="setting-card">
        <div class="setting-label">è‡ªå‹•èª­ã¿ Â· Auto Speak</div>
        <div class="auto-speak-row">
          <div class="auto-speak-info">
            <div class="title">è‡ªå‹•ç™ºéŸ³</div>
            <div class="desc">ã‚«ãƒ¼ãƒ‰ã‚’è£è¿”ã™ã¨<br>è‡ªå‹•ã§èª­ã¿ä¸Šã’ã¾ã™</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="auto-speak-toggle">
            <div class="toggle-track">
              <div class="toggle-thumb"></div>
            </div>
          </label>
        </div>
      </div>

      <!-- Start button -->
      <button class="start-btn" id="start-btn">
        ã¯ã˜ã‚ã‚‹ Â· Start
        <span class="arrow">â†’</span>
      </button>
    </div>
  </div>

  <!-- â•â•â•â•â•â• FLASHCARD PAGE â•â•â•â•â•â• -->
  <div id="flash-page" class="page hidden">
    <!-- Top bar -->
    <div class="flash-topbar">
      <button class="back-btn" id="back-btn">â†</button>
      <div class="progress-info">
        <div class="progress-text" id="progress-text">1 / 7</div>
        <div class="progress-sub">ã‚«ãƒ¼ãƒ‰</div>
      </div>
      <button class="shuffle-btn" id="shuffle-btn" title="Shuffle">â‡Œ</button>
    </div>

    <!-- Progress bar -->
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="progress-bar" style="width:0%"></div>
    </div>

    <!-- Card area -->
    <div class="card-area" id="card-area">
      <div class="card-scene" id="card-scene">
        <div class="card-inner" id="card-inner">
          <!-- Front -->
          <div class="card-face card-front" id="card-front">
            <div class="card-image-wrap" id="card-image-wrap">
              <img class="card-img" id="card-img" src="" alt="" />
              <div class="card-img-fallback" id="card-img-fallback"></div>
            </div>
            <div class="card-front-label">
              <div class="romaji" id="card-romaji">nozomi</div>
            </div>
            <div class="tap-hint">TAP</div>
          </div>
          <!-- Back -->
          <div class="card-face card-back" id="card-back">
            <div class="card-back-content">
              <div class="kana-display" id="kana-display">ã®ãã¿</div>
            </div>
            <div class="card-back-footer">
              <div class="kana-romaji" id="kana-romaji-back">nozomi</div>
              <button class="sound-btn" id="sound-btn">ğŸ”Š</button>
            </div>
          </div>
        </div>
      </div>

      <div class="swipe-hint" id="swipe-hint">
        <span>â† prev</span>
        <span class="dot"></span>
        <span>swipe</span>
        <span class="dot"></span>
        <span>next â†’</span>
      </div>
    </div>

    <!-- Complete screen -->
    <div class="complete-screen" id="complete-screen">
      <div class="complete-kanji">å®Œäº†</div>
      <div class="complete-title">ã‚ˆãã§ãã¾ã—ãŸï¼</div>
      <div class="complete-sub">Well done! You've reviewed all cards.</div>
      <button class="complete-btn complete-btn-primary" id="restart-btn">
        ã‚‚ã†ä¸€åº¦ Â· Play Again
      </button>
      <button class="complete-btn complete-btn-secondary" id="home-from-complete-btn">
        ãƒ›ãƒ¼ãƒ  Â· Home
      </button>
    </div>
  </div>

  <!-- Auto speak toast -->
  <div class="autospeak-indicator" id="autospeak-indicator">ğŸ”Š è‡ªå‹•èª­ã¿</div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DATA_URL = "https://script.google.com/macros/s/AKfycbx4-RVM7zUulVcK1EZbNXY3wWcsRp-SRWoNH7VxpqOfh96GbvHJAx-R8EfN2Cdj1kz1_w/exec";
let DATA = {
  version: "remote",
  topics: [],
  cards: []
};

async function loadAppData() {
  try {
    const res = await fetch(DATA_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();

    const topics = Array.isArray(json?.topics) ? json.topics : [];
    const cards = Array.isArray(json?.cards) ? json.cards : [];

    DATA = {
      version: json?.version || "remote",
      topics,
      cards
    };

    return true;
  } catch (error) {
    console.error('Failed to load app data:', error);
    alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u tá»« server. Vui lÃ²ng thá»­ láº¡i.');
    return false;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE & SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let settings = {
  script: 'hiragana',
  topicId: 'shinkansen',
  autoSpeak: false
};

let cards = [];
let currentIndex = 0;
let isFlipped = false;
let swipeHintShown = false;

// â”€â”€ Load from localStorage â”€â”€
function loadSettings() {
  try {
    const saved = JSON.parse(localStorage.getItem('jpFlashSettings') || '{}');
    settings = { ...settings, ...saved };
  } catch(e) {}
}

function saveSettings() {
  try {
    localStorage.setItem('jpFlashSettings', JSON.stringify(settings));
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FISHER-YATES SHUFFLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOM REFS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const homePage = document.getElementById('home-page');
const flashPage = document.getElementById('flash-page');
const cardScene = document.getElementById('card-scene');
const cardInner = document.getElementById('card-inner');
const cardImg = document.getElementById('card-img');
const cardImgFallback = document.getElementById('card-img-fallback');
const cardRomaji = document.getElementById('card-romaji');
const kanaDisplay = document.getElementById('kana-display');
const kanaRomajiBack = document.getElementById('kana-romaji-back');
const progressText = document.getElementById('progress-text');
const progressBar = document.getElementById('progress-bar');
const soundBtn = document.getElementById('sound-btn');
const completeScreen = document.getElementById('complete-screen');
const swipeHint = document.getElementById('swipe-hint');
const autospeakIndicator = document.getElementById('autospeak-indicator');
const topicGrid = document.querySelector('.topic-grid');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME PAGE LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderTopicButtons() {
  topicGrid.innerHTML = '';

  DATA.topics.forEach(topic => {
    const count = DATA.cards.filter(card => card.topicId === topic.id).length;
    const button = document.createElement('button');
    button.className = 'topic-btn';
    button.dataset.topic = topic.id;
    button.innerHTML = `
      <span class="icon">${topic.emoji || 'ğŸ“š'}</span>
      <span class="jp-name">${topic.name || topic.id}</span>
      <span class="count">${count} cards</span>
    `;
    topicGrid.appendChild(button);
  });

  if (!DATA.topics.some(topic => topic.id === settings.topicId)) {
    settings.topicId = DATA.topics[0]?.id || '';
  }
}

function applyHomepageSettings() {
  // Script buttons
  document.querySelectorAll('.script-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.script === settings.script);
  });
  // Topic buttons
  document.querySelectorAll('.topic-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.topic === settings.topicId);
  });
  // Auto speak
  document.getElementById('auto-speak-toggle').checked = settings.autoSpeak;
}

document.querySelectorAll('.script-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    settings.script = btn.dataset.script;
    document.querySelectorAll('.script-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    saveSettings();
  });
});

topicGrid.addEventListener('click', (e) => {
  const btn = e.target.closest('.topic-btn');
  if (!btn) return;

  settings.topicId = btn.dataset.topic;
  document.querySelectorAll('.topic-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  saveSettings();
});

document.getElementById('auto-speak-toggle').addEventListener('change', (e) => {
  settings.autoSpeak = e.target.checked;
  saveSettings();
});

document.getElementById('start-btn').addEventListener('click', () => {
  if (!DATA.cards.length) return;
  saveSettings();
  startFlashcards();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startFlashcards() {
  // Filter + shuffle
  const filtered = DATA.cards.filter(c => c.topicId === settings.topicId);
  if (!filtered.length) return;
  cards = shuffle(filtered);
  currentIndex = 0;
  isFlipped = false;
  swipeHintShown = false;

  // Transition
  homePage.classList.add('slide-out');
  flashPage.classList.remove('hidden');

  renderCard('right');
  updateProgress();

  // Show swipe hint briefly
  swipeHint.classList.remove('faded');
  setTimeout(() => { swipeHint.classList.add('faded'); }, 3000);
}

function goHome() {
  flashPage.classList.add('hidden');
  homePage.classList.remove('slide-out');
  completeScreen.classList.remove('visible');
  cancelSpeech();
}

document.getElementById('back-btn').addEventListener('click', goHome);
document.getElementById('home-from-complete-btn').addEventListener('click', goHome);

document.getElementById('restart-btn').addEventListener('click', () => {
  completeScreen.classList.remove('visible');
  cards = shuffle(cards);
  currentIndex = 0;
  isFlipped = false;
  renderCard('right');
  updateProgress();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIT FRONT KANA TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fitFrontKana() {
  const maxSize = 28;
  const minSize = 14;
  const padding = 40; // horizontal padding
  cardRomaji.style.fontSize = maxSize + 'px';
  const available = cardRomaji.parentElement.offsetWidth - padding;
  if (available <= 0) return;
  const textWidth = cardRomaji.scrollWidth;
  if (textWidth > available) {
    const ratio = available / textWidth;
    const fitted = Math.max(minSize, Math.floor(maxSize * ratio));
    cardRomaji.style.fontSize = fitted + 'px';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIT KANA TEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fitKanaText() {
  const maxSize = 88;
  const minSize = 28;
  const padding = 32; // total horizontal padding inside card
  kanaDisplay.style.fontSize = maxSize + 'px';
  const available = kanaDisplay.parentElement.offsetWidth - padding;
  if (available <= 0) return;
  const textWidth = kanaDisplay.scrollWidth;
  if (textWidth > available) {
    const ratio = available / textWidth;
    const fitted = Math.max(minSize, Math.floor(maxSize * ratio));
    kanaDisplay.style.fontSize = fitted + 'px';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderCard(dir = 'right') {
  const card = cards[currentIndex];
  if (!card) return;

  // Reset flip
  isFlipped = false;
  cardInner.classList.remove('flipped');

  // Image with fallback to emoji
  cardImgFallback.textContent = card.emoji;
  cardImg.classList.add('loading');
  cardImg.classList.remove('error');
  cardImg.alt = card.romaji;
  cardImg.onload = () => cardImg.classList.remove('loading');
  cardImg.onerror = () => { cardImg.classList.remove('loading'); cardImg.classList.add('error'); };
  cardImg.src = card.image;
  
  // Show kana on front (not romaji)
  const kana = card.kana[settings.script];
  cardRomaji.textContent = kana;
  requestAnimationFrame(fitFrontKana);

  // Kana on back
  kanaDisplay.textContent = kana;
  kanaRomajiBack.textContent = card.romaji;
  requestAnimationFrame(fitKanaText);

  // Animation
  cardScene.classList.remove('anim-right', 'anim-left');
  void cardScene.offsetWidth; // reflow
  cardScene.classList.add(dir === 'right' ? 'anim-right' : 'anim-left');
  setTimeout(() => cardScene.classList.remove('anim-right', 'anim-left'), 400);

  updateProgress();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateProgress() {
  const total = cards.length;
  const current = currentIndex + 1;
  progressText.textContent = `${current} / ${total}`;
  progressBar.style.width = `${(current / total) * 100}%`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FLIP CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function flipCard() {
  isFlipped = !isFlipped;
  cardInner.classList.toggle('flipped', isFlipped);

  if (isFlipped && settings.autoSpeak) {
    setTimeout(() => {
      speak(cards[currentIndex].kana[settings.script]);
      showAutospeakIndicator();
    }, 300);
  }
}

function resetCardToFront() {
  isFlipped = false;
  cardInner.classList.remove('flipped');
  cardInner.style.transform = '';
}

cardScene.addEventListener('click', (e) => {
  if (e.target === soundBtn || soundBtn.contains(e.target)) return;
  flipCard();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION (NEXT / PREV)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nextCard() {
  if (currentIndex >= cards.length - 1) {
    showComplete();
    return;
  }
  resetCardToFront();
  currentIndex++;
  renderCard('right');
  cancelSpeech();
}

function prevCard() {
  if (currentIndex <= 0) return;
  resetCardToFront();
  currentIndex--;
  renderCard('left');
  cancelSpeech();
}

function showComplete() {
  completeScreen.classList.add('visible');
}

// Shuffle button
document.getElementById('shuffle-btn').addEventListener('click', () => {
  cards = shuffle(cards);
  currentIndex = 0;
  isFlipped = false;
  renderCard('right');
  buildDots();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SWIPE / DRAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let touchStartX = 0;
let touchStartY = 0;
let isDragging = false;
let dragX = 0;
const SWIPE_THRESHOLD = 60;

cardScene.addEventListener('touchstart', (e) => {
  touchStartX = e.touches[0].clientX;
  touchStartY = e.touches[0].clientY;
  isDragging = false;
  dragX = 0;
}, { passive: true });

cardScene.addEventListener('touchmove', (e) => {
  const dx = e.touches[0].clientX - touchStartX;
  const dy = e.touches[0].clientY - touchStartY;
  if (!isDragging && Math.abs(dx) > 8 && Math.abs(dy) < 30) {
    isDragging = true;
    cardScene.classList.add('dragging');
  }
  if (isDragging) {
    dragX = dx;
    cardInner.style.transform = isFlipped
      ? `rotateY(180deg) translateX(${-dragX * 0.5}px) rotate(${-dragX * 0.02}deg)`
      : `translateX(${dragX * 0.4}px) rotate(${dragX * 0.015}deg)`;
    e.preventDefault();
  }
}, { passive: false });

cardScene.addEventListener('touchend', () => {
  cardScene.classList.remove('dragging');
  cardInner.style.transform = '';

  if (isDragging) {
    if (dragX < -SWIPE_THRESHOLD) nextCard();
    else if (dragX > SWIPE_THRESHOLD) prevCard();
    isDragging = false;
    dragX = 0;
    return;
  }
});

// Mouse drag (desktop)
let mouseDown = false;
let mouseStartX = 0;

cardScene.addEventListener('mousedown', (e) => {
  mouseDown = true;
  mouseStartX = e.clientX;
  isDragging = false;
  dragX = 0;
});

window.addEventListener('mousemove', (e) => {
  if (!mouseDown) return;
  const dx = e.clientX - mouseStartX;
  if (!isDragging && Math.abs(dx) > 10) {
    isDragging = true;
    cardScene.classList.add('dragging');
  }
  if (isDragging) {
    dragX = dx;
    cardInner.style.transform = isFlipped
      ? `rotateY(180deg) translateX(${-dragX * 0.5}px) rotate(${-dragX * 0.02}deg)`
      : `translateX(${dragX * 0.4}px) rotate(${dragX * 0.015}deg)`;
  }
});

window.addEventListener('mouseup', () => {
  if (!mouseDown) return;
  mouseDown = false;
  cardScene.classList.remove('dragging');
  cardInner.style.transform = '';

  if (isDragging) {
    if (dragX < -SWIPE_THRESHOLD) nextCard();
    else if (dragX > SWIPE_THRESHOLD) prevCard();
  }
  isDragging = false;
  dragX = 0;
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// KEYBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown', (e) => {
  if (flashPage.classList.contains('hidden')) return;
  if (e.key === 'ArrowRight') nextCard();
  else if (e.key === 'ArrowLeft') prevCard();
  else if (e.key === ' ' || e.key === 'Enter') flipCard();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SPEECH SYNTHESIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUtterance = null;

function speak(text) {
  if (!('speechSynthesis' in window)) return;
  cancelSpeech();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ja-JP';
  utter.rate = 0.85;
  utter.pitch = 1.0;
  currentUtterance = utter;

  soundBtn.classList.add('playing');
  utter.onend = () => {
    soundBtn.classList.remove('playing');
    currentUtterance = null;
  };
  utter.onerror = () => {
    soundBtn.classList.remove('playing');
    currentUtterance = null;
  };
  speechSynthesis.speak(utter);
}

function cancelSpeech() {
  if ('speechSynthesis' in window) speechSynthesis.cancel();
  soundBtn.classList.remove('playing');
  currentUtterance = null;
}

soundBtn.addEventListener('click', (e) => {
  e.stopPropagation();
  const kana = cards[currentIndex]?.kana[settings.script];
  if (kana) speak(kana);
});

function showAutospeakIndicator() {
  autospeakIndicator.classList.add('show');
  setTimeout(() => autospeakIndicator.classList.remove('show'), 1500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  loadSettings();
  const loaded = await loadAppData();
  if (!loaded) return;

  renderTopicButtons();
  applyHomepageSettings();
}

initApp();
</script>
</body>
</html>
